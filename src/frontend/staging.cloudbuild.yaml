#steps:
#- id: 'Create Container'
#  name: 'gcr.io/cloud-builders/docker'
#  args: ['build', '--tag=gcr.io/$_IMAGE_REPO/frontend:$COMMIT_SHA', 'src/frontend/']

#- id: 'Push Container to Staging registry'
#  name: 'gcr.io/cloud-builders/docker'
#  args: ["push", "gcr.io/$_IMAGE_REPO/frontend:$COMMIT_SHA"]

#- id: 'Deploy to Staging Cluster'
#  name: 'gcr.io/cloud-builders/kubectl'
#  args:
#  - 'set'
#  - 'image'
#  - 'deployment/frontend'
#  - 'server=gcr.io/$_IMAGE_REPO/frontend:$COMMIT_SHA'
#  env:
#  - 'CLOUDSDK_COMPUTE_ZONE=$_CLUSTER_ZONE'
#  - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER_NAME'
#  - 'CLOUDSDK_CORE_PROJECT=$_CLUSTER_PROJECT'



  - id: 'Copy Git SSH Auth Key into Source Folder'
    name: gcr.io/cloud-builders/gsutil
    args: ['cp', 'gs://$PROJECT_ID-github/github_rsa', '/workspace/id_rsa']

  - id: 'Prepare Git Hub'
    name: 'gcr.io/cloud-builders/gcloud'
    dir: /workspace/src
    entrypoint: './githubssh.sh'
    volumes:
    - name: 'ssh-setup'
      path: /root/.ssh

  - id: 'Git Clone demo-cfg'
    name: 'gcr.io/cloud-builders/git'
    args: ['clone', 'https://github.com/bkauf/microservices-demo-cfg.git']

  - id: 'Get Updated Manifest'
    name: 'gcr.io/cloud-builders/kubectl'
    entrypoint: 'bash'
    dir: microservices-demo-cfg/staging
    args:
    - '-c' # pass what follows as a command to bash
    - |
      gcloud container clusters get-credentials --zone=$_CLUSTER_ZONE --project=$_CLUSTER_PROJECT $_CLUSTER_NAME
      kubectl get deployment -o yaml > deployments.yaml

  - id: 'Copy Manifest'
    name: gcr.io/cloud-builders/gsutil
    dir: microservices-demo-cfg/staging
    args: ['cp','$_CLUSTER_NAME-deployments.yaml', 'gs://$PROJECT_ID-github/$_CLUSTER_NAME-deployments.yaml']

  - id: 'Git Checkout, commit'
    name: 'gcr.io/cloud-builders/git'
    dir: microservices-demo-cfg/
    entrypoint: 'bash'
    args:
    - '-c' # pass what follows as a command to bash
    - |
      git checkout -B "master"
      git config --global user.email cloudbuild@cicdnotary.com
      git commit -am "Cloud Build Update Manifest"

  #git add release/deployment-manifest.yaml

  #- id: 'Git Pull'
  #  name: 'gcr.io/cloud-builders/git'
  #  args: ['pull', 'origin', 'master']


  - id: 'GitHub Push'
    name: 'gcr.io/cloud-builders/git'
    dir: microservices-demo-cfg/
    env:
    - GIT_SSH=src/git-ssh.sh
    args:
    - push
    - git@github.com:bkauf/microservices-demo-cfg
    - master
    volumes:
    - name: 'ssh-setup'
      path: /root/.ssh
