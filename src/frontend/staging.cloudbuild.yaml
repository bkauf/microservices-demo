steps:
#- id: 'Create Container'
#  name: 'gcr.io/cloud-builders/docker'
#  args: ['build', '--tag=gcr.io/$_IMAGE_REPO/frontend:$COMMIT_SHA', 'src/frontend/']

#- id: 'Push Container to Staging registry'
#  name: 'gcr.io/cloud-builders/docker'
#  args: ["push", "gcr.io/$_IMAGE_REPO/frontend:$COMMIT_SHA"]

#- id: 'Deploy to Staging Cluster'
#  name: 'gcr.io/cloud-builders/kubectl'
#  args:
#  - 'set'
#  - 'image'
#  - 'deployment/frontend'
#  - 'server=gcr.io/$_IMAGE_REPO/frontend:$COMMIT_SHA'
#  env:
#  - 'CLOUDSDK_COMPUTE_ZONE=$_CLUSTER_ZONE'
#  - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER_NAME'
#  - 'CLOUDSDK_CORE_PROJECT=$_CLUSTER_PROJECT'



#- id: 'Git Clone'
#  name: 'gcr.io/cloud-builders/git'
#  args: ['clone', '-b', 'staging', 'https://github.com/bkauf/microservices-demo.git']



# Prepare for github
- id: 'Copy Git SSH Auth Key into Source Folder'
  name: gcr.io/cloud-builders/gsutil
  args: ['cp', 'gs://$PROJECT_ID-github/github_rsa', '/workspace/id_rsa']


- id: 'Prepair Git Hub'
  name: 'gcr.io/cloud-builders/gcloud'
  dir: /workspace/src
  entrypoint: './githubssh.sh'
  volumes:
  - name: 'ssh-setup'
    path: /root/.ssh

- id: 'Git Config'
  name: 'gcr.io/cloud-builders/git'
      #entrypoint: 'bash'
  args:
  - config
  - --global
  - user.email
  - brian.kaufman@gmail.com

- id: 'Pull Git Hub'
  name: 'gcr.io/cloud-builders/git'
  env:
  - GIT_SSH=src/git-ssh.sh
  args:
  - pull
  - git@github.com:bkauf/microservices-demo
  - staging
  volumes:
  - name: 'ssh-setup'
    path: /root/.ssh

- id: 'Get Updated Manifest'
  name: 'gcr.io/cloud-builders/kubectl'
  #entrypoint: 'bash'
  dir: release
  #args: ['kubectl get deployment -o yaml']
  #,'> deployment-manifest.yaml']
  #args: ['../src/frontend/buildcmd.sh']
  args: ['-c', 'kubectl get deployment -o yaml > deployment-manifest.yaml']

  env:
  - 'CLOUDSDK_COMPUTE_ZONE=$_CLUSTER_ZONE'
  - 'CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER_NAME'
  - 'CLOUDSDK_CORE_PROJECT=$_CLUSTER_PROJECT'


- id: 'Copy manifest '
  name: gcr.io/cloud-builders/gsutil
  args: ['cp', 'release/deployment-manifests.yaml', 'gs://$PROJECT_ID-github/test.yaml']

- id: 'Git Commit'
  name: 'gcr.io/cloud-builders/git'
  #entrypoint: 'bash'
  args:
  - commit
  - -am
  - "update manifest"

- id: 'GitHub Push'
  name: 'gcr.io/cloud-builders/git'
  env:
  - GIT_SSH=src/git-ssh.sh
  args:
  - push
  - git@github.com:bkauf/microservices-demo
  - staging
  volumes:
  - name: 'ssh-setup'
    path: /root/.ssh



#- id: 'Push Git'
#  name: 'bkauf/cb-git:1.4'
#  args: ['cat src/id_rsa' ]
#- id: 'Push Manifest'
#  name: 'gcr.io/cloud-builders/git'
#  entrypoint: /bin/bash
#  args:

#    - 'git'
#    - 'push'
#    - 'git@github.com:bkauf/microservices-demo'
#    - 'master'
#options:
  #machineType: 'N1_HIGHCPU_8'
